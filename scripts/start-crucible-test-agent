#/bin/bash

absolute_path() {
  (cd "$1" && pwd)
}

scripts_path=$(absolute_path "$(dirname "$0")" )

export GOPATH=$scripts_path/..
export PATH=$GOPATH/bin:$PATH

${scripts_path}/mountgroups.sh

go install crucible
go install crucible-acceptance/fixtures/crucible-test-agent

mkdir -p /var/vcap/packages/crucible-test-agent/bin

cp `which crucible-test-agent` /var/vcap/packages/crucible-test-agent/bin

mkdir -p /var/vcap/jobs/crucible-test-agent/config/

cat << EOF > /var/vcap/jobs/crucible-test-agent/config/crucible.yml
name: crucible-test-agent
executable: /var/vcap/packages/crucible-test-agent/bin/crucible-test-agent
args:
  - --port
  - 1337
env:
  - CRUCIBLE=SWEET
EOF

crucible start -j crucible-test-agent -c /var/vcap/jobs/crucible-test-agent/config/crucible.yml
